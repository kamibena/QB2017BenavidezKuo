---
title: "Untitled"
author: "Venus"
date: "February 16, 2017"
output: html_document
---
## Setup work enviroment ##

```{r}
## Setup work enviroment ##
rm(list = ls())
setwd("C:/Users/Venus/Github/QB2017BenavidezKuo/data")

## Load packages ##
require("vegan")  
require("tidyr")
require("dplyr")
```

## Load dataset ##

```{r}
setwd("C:/Users/Venus/Github/QB2017BenavidezKuo/data")
# From BCI, Panama from year 2000 #
BCI <- read.delim("BCI2010.txt", header=T)

# Slim down BCI data frame #
#BCI.df <- subset(BCI, select = c(No., Latin, Quadrat, PX, PY))

# Make Quadrat into factors #
BCI$Quadrat <- as.factor(BCI$Quadrat)

# Find which quadrat has min individuals # 

```

## Using for loop ## 
# For loop to randomly sample quadrat in BCI.dat #

```{r}
# For loop to randomly sample quadrat in BCI.dat #
# Define intermediate data frame to populate in for loop # 
neighbor.df <- data.frame()
# Define number of quadrats, 1250 # 
nquad <- nlevels(BCI$Quadrat)
# For every quadrat in BCI ... # 
for(i in 1:nquad) {
  # Subset the No. Latin, Quadrat, PX, PY from each quadrat # 
  BCI.Q.df <- subset(BCI, Quadrat == i , select = c(No., Latin, Quadrat, PX, PY)) 
  
  # Define value for n using ifelse statement #
  if (100 < as.numeric(nrow(BCI.Q.df))) {
      n <- 100;
  } else if (100 >= as.numeric(nrow(BCI.Q.df))) {
       n <- as.numeric(nrow(BCI.Q.df))
  }
  
  # Define df of randomly sampled 200 or less individuals from each quadrat #
  ilist <- BCI.Q.df[sample(nrow(BCI.Q.df), size = n, replace = FALSE), ]
  
  # Define number of individuals sampled in ilist and total individuals in sampled quadrat # 
  nrows.1 <- nrow(ilist)
  nrows.2 <- nrow(BCI.Q.df)
  
    # Inner for loop #
    # For every individual in ilist, find the PX, PY, Latin, and No. to put into individual df #
     for(i in 1:nrows.1) {   
        x1 <- as.numeric(ilist[i,]["PX"])
        y1 <- as.numeric(ilist[i,]["PY"])
        spID <- ilist[i,]["Latin"]
        No <- ilist[i,]["No."]
        individual <- cbind(No, spID, x1, y1)
        
        # Define temporary df for all neighbors in each ilist individual # 
        temp.neighbor.df <- data.frame()
 
          # Innest for loop # 
          # For each indiviudal in quadrat, find the distance between ilist individuals to quadrat individuals#
          for(j in 1:nrows.2) {
             x2 <- as.numeric(BCI.Q.df[j,]["PX"])
             y2 <- as.numeric(BCI.Q.df[j,]["PY"])
             spID2 <- BCI.Q.df[j,]["Latin"]
             No2 <- BCI.Q.df[j,]["No."]
             dist <- sqrt(((x1-x2)^2)+((y1-y2)^2))
             neighbor <- cbind(spID, No, spID2, No2, x2, y2, dist)
             # Put all neighbors for each invidual into temp.neighbor.df # 
             temp.neighbor.df <- rbind(temp.neighbor.df, neighbor)
  }
  
  # Order neighbors by closest distance #
  temp.neighbor.df <- temp.neighbor.df[order(temp.neighbor.df$dist),]
  # The four closest neighbors and of each sampled indivudal put into neighbor.df # 
  neighbor.df <- rbind(neighbor.df, temp.neighbor.df[2:5, -c(5:7)])
    }
}


```

# Removing redundancy #

``` {r}
# Rename column #
colnames(neighbor.df) <- c("Individual", "Individual No.", "Neighbors", "Neighbors No.")

# Removing combinatorial redundancy in neighbor.df #
# Take Individual and Neighbors species name combination in alphabetical order then n1-n2=n # 
onesided.count.Q.df <- data.frame(t(apply(neighbor.df,1,sort)))
onesided.count.Q.df <- onesided.count.Q.df[!duplicated(onesided.count.Q.df),]

# Reorder dataframe # 
onesided.count.Q.df <- onesided.count.Q.df[,-c(1:2)]
colnames(onesided.count.Q.df) <- c("Individual", "Neighbors")
#onesided.count.Q.df <- onesided.count.Q.df[c(2,3,1)]


# Making count dataframe table based on neighbor.df #
count.Q.df <- group_by(onesided.count.Q.df, Individual) %>% count(Neighbors) # %>% spread(key=Neighbors, value=n, fill=0)

```



```{r}

# Row Names changed #
x <- as.matrix(neighbor.df$Individual)
y <- as.matrix(neighbor.df$Neighbors)
z <- rbind(c(x,y))
zz <- t(z)
z <- t(unique(zz))
count.Q.df <- count.Q.df[,-1]
row.names(count.Q.df) <- sort(unique(zz))


```

# Making Squared matrix for species

```{r}
# Make squared matrix for species #

length(unique(neighbor.df$Individual)) 
length(unique(neighbor.df$Neighbors)) 
x <- as.matrix(neighbor.df$Individual)
y <- as.matrix(neighbor.df$Neighbors)
z <- rbind(c(x,y))
zz <- t(z)
z <- t(unique(zz))
length(unique(zz)) 
squared <- matrix(0 , nrow = length(unique(zz)), ncol=length(unique(zz)))
row.names(squared) <- sort(unique(zz))
colnames(squared) <- sort(z)


# Populate the squared matrix with coocurrance information from neighbor.df #
nrow.3 <- nrow(count.Q.df)
for(k in nrow.3) {
  n <- as.numeric(count.Q.df[k,]["n"])
  squared[which(rownames(count.Q.df[k,]))]
  squared[which(rownames(count))]  <- count.Q.df[k,]["n"]
  which(rownames(distance)==76),which(colnames(distance)!=76
  squared <- count.Q.df[,3]
}



```

# Generating Null model as metric for species co-occurances #

```{r}
# Randomizing the PX and PY coord in BCI.
BCI.df.random.r <- transform(BCI.df, PX = sample(PX), PY=sample(PY))

# For loop to generate randomized neighboors of sampled individuals #
neighbor.df.r <- data.frame()
nquadr <- nlevels(BCI$Quadrat)
for(i in 1:nquadr) {
  BCI.Q.df.r <- subset(BCI.df.random.r, Quadrat == i , select = c(No., Latin, Quadrat, PX, PY))
  #BCI.df.random <- transform(BCI.Q.df, PX = sample(PX), PY=sample(PY))
  ilist.r <- BCI.Q.df[sample(nrow(BCI.Q.df), size = 100, replace = FALSE), ]

  nrows.1.r <- nrow(ilist.r)
  nrows.2.r <- nrow(BCI.Q.df.r)
  
     for(i in 1:nrows.1.r) {  
        x1.r <- as.numeric(ilist.r[i,]["PX"])
        y1.r <- as.numeric(ilist.r[i,]["PY"])
        spID.r <- ilist.r[i,]["Latin"]
        No.r <- ilist.r[i,]["No."]
        individual.r <- cbind(No, spID, x1, y1)
  
        temp.neighbor.df.r <- data.frame()
 
          for(j in 1:nrows.2.r) {
             x2.r <- as.numeric(BCI.Q.df.r[j,]["PX"])
             y2.r <- as.numeric(BCI.Q.df.r[j,]["PY"])
             spID2.r <- BCI.Q.df.r[j,]["Latin"]
             No2.r <- BCI.Q.df.r[j,]["No."]
             dist.r <- sqrt(((x1-x2)^2)+((y1-y2)^2))
             neighbor.r <- cbind(spID.r, No.r, spID2.r, No2.r, x2.r, y2.r, dist.r)
             temp.neighbor.df.r <- rbind(temp.neighbor.df.r, neighbor.r)
  }
  
  temp.neighbor.df.r <- temp.neighbor.df.r[order(temp.neighbor.df.r$dist.r),]
  neighbor.df.r <- rbind(neighbor.df.r, temp.neighbor.df.r[2:5,-5:-7])
    }
}

# Rename column #
colnames(neighbor.df.r) <- c("Individual", "Individual No.", "Neighbors", "Neighbors No.")

# Making count dataframe table based on neighbor.df #
count.Q.df.r <- group_by(neighbor.df.r, Individual) %>% count(Neighbors) %>% spread(key=Neighbors, value=n, fill=0)

# Row Names changed #
x.r <- as.matrix(neighbor.df.r$Individual)
y.r <- as.matrix(neighbor.df.r$Neighbors)
z.r <- rbind(c(x.r,y.r))
zz.r <- t(z.r)
z.r <- t(unique(zz.r))
count.Q.df.r <- count.Q.df.r[,-1]
row.names(count.Q.df.r) <- sort(unique(zz.r))


```















